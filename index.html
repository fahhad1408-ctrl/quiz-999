<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  body {font-family: Tahoma; background:#f2f2f2; text-align:center; margin:0; padding:20px;}
  .hidden {display:none;}
  .screen {max-width:600px; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px #ccc;}
  button {padding:10px 20px; margin:10px; cursor:pointer; background:#007bff; color:white; border:none; border-radius:5px;}
  button:hover {background:#0056b3;}
  input[type="text"], input[type="password"], input[type="file"] {padding:8px; width:90%; margin:10px 0;}
  img {max-width:100%; border:1px solid #ddd; margin:10px 0;}
</style>
</head>
<body>

<!-- ğŸŸ¢ Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
<div id="startScreen" class="screen">
  <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ğŸ‘‹</h2>
  <p>Ø§Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</p>
  <input type="text" id="userCode" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§">
  <button id="activateBtn">ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯</button>
  <p id="activationMsg"></p>
</div>

<!-- ğŸŸ¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
<div id="quizScreen" class="screen hidden">
  <img id="questionImage" src="" alt="Ø§Ù„Ø³Ø¤Ø§Ù„">
  <div id="choices"></div>
  <p id="feedback"></p>
  <button id="nextBtn" class="hidden">Ø§Ù„ØªØ§Ù„ÙŠ</button>
</div>

<!-- ğŸ”µ Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
<div id="resultScreen" class="screen hidden">
  <h2>Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ğŸ¯</h2>
  <p id="finalScore"></p>
  <p id="weakPoints"></p>
  <button onclick="restart()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
</div>

<!-- ğŸ”´ Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù† -->
<div id="adminScreen" class="screen hidden">
  <div id="adminLogin">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù† ğŸ”</h2>
    <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
    <p id="loginMsg"></p>
  </div>

  <div id="adminPanel" class="hidden">
    <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
    <p>ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Excel:</p>
    <input type="file" id="codesFile" accept=".xlsx">
    <input type="file" id="questionsFile" accept=".xlsx">
    <button id="saveAdminData">Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª</button>
    <hr>
    <h4>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h4>
    <input type="password" id="newPass" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©">
    <button id="updatePass">ØªØ­Ø¯ÙŠØ«</button>
    <p id="updateMsg"></p>
  </div>
</div>

<script>
let codesData = [];
let questions = [];
let currentQuestion = 0;
let score = 0;
let weakSections = [];

/* ========== 1. Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„ÙØ§Øª Excel ========== */
function readExcel(file, callback) {
  const reader = new FileReader();
  reader.onload = e => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, {type:'array'});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, {header:1});
    callback(json);
  };
  reader.readAsArrayBuffer(file);
}

document.getElementById("codesFile").addEventListener("change", e => {
  readExcel(e.target.files[0], data => {
    codesData = data.slice(1).map(r => ({code:r[0]}));
    alert("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.");
  });
});

document.getElementById("questionsFile").addEventListener("change", e => {
  readExcel(e.target.files[0], data => {
    questions = data.slice(1).map(r => ({
      image:r[0],
      choices:r[1].split("ØŒ"),
      correct:r[2],
      explain:r[3],
      section:r[5]
    }));
    alert("âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­.");
  });
});

/* ========== 2. ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ========== */
document.getElementById("activateBtn").addEventListener("click", () => {
  const code = document.getElementById("userCode").value.trim();
  const msg = document.getElementById("activationMsg");

  if (!code) {
    msg.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯.";
    msg.style.color = "red";
    return;
  }

  if (localStorage.getItem("used_" + code)) {
    msg.textContent = "âš ï¸ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø².";
    msg.style.color = "red";
    return;
  }

  const found = codesData.find(c => c.code === code);

  if (found) {
    const userId = "ID-" + Math.floor(Math.random() * 1000000);
    const date = new Date().toLocaleString("ar-SA");
    localStorage.setItem("used_" + code, JSON.stringify({userId, date}));
    msg.textContent = "âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­!";
    msg.style.color = "green";
    setTimeout(() => {
      document.getElementById("startScreen").classList.add("hidden");
      document.getElementById("quizScreen").classList.remove("hidden");
      startQuiz();
    }, 1000);
  } else {
    msg.textContent = "âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­. Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±.";
    msg.style.color = "red";
  }
});

/* ========== 3. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ========== */
function startQuiz() {
  currentQuestion = 0;
  score = 0;
  weakSections = [];
  showQuestion();
}

function showQuestion() {
  const q = questions[currentQuestion];
  document.getElementById("questionImage").src = q.image;
  const cDiv = document.getElementById("choices");
  cDiv.innerHTML = "";
  q.choices.forEach(ch => {
    const btn = document.createElement("button");
    btn.textContent = ch.trim();
    btn.onclick = () => checkAnswer(ch.trim());
    cDiv.appendChild(btn);
  });
  document.getElementById("feedback").textContent = "";
  document.getElementById("nextBtn").classList.add("hidden");
}

function checkAnswer(choice) {
  const q = questions[currentQuestion];
  const feedback = document.getElementById("feedback");
  const correctChoice = q.correct.trim();

  if (choice.startsWith(correctChoice)) {
    score++;
    feedback.innerHTML = "âœ… Ø¥Ø¬Ø§Ø¨ØªÙƒ ØµØ­ÙŠØ­Ø©!";
  } else {
    feedback.innerHTML = `âŒ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø®Ø§Ø·Ø¦Ø©. Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ: ${correctChoice}`;
    weakSections.push(q.section);
  }

  if (q.explain) {
    const img = document.createElement("img");
    img.src = q.explain;
    feedback.appendChild(img);
  }

  document.getElementById("nextBtn").classList.remove("hidden");
}

document.getElementById("nextBtn").addEventListener("click", () => {
  currentQuestion++;
  if (currentQuestion < questions.length) showQuestion();
  else showResult();
});

function showResult() {
  document.getElementById("quizScreen").classList.add("hidden");
  document.getElementById("resultScreen").classList.remove("hidden");
  const percent = Math.round((score / questions.length) * 100);
  document.getElementById("finalScore").textContent = `Ù†ØªÙŠØ¬ØªÙƒ: ${percent} Ù…Ù† 100`;
  const unique = [...new Set(weakSections)];
  document.getElementById("weakPoints").textContent = unique.length ? "Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù: " + unique.join("ØŒ ") : "Ù…Ù…ØªØ§Ø²! Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù.";
}

/* ========== 4. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ========== */
function restart() {
  document.getElementById("resultScreen").classList.add("hidden");
  document.getElementById("startScreen").classList.remove("hidden");
}

/* ========== 5. Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø¯Ù…Ù† ========== */
const defaultAdminPass = "admin77880";
let currentAdminPass = localStorage.getItem("adminPass") || defaultAdminPass;

window.addEventListener("load", () => {
  if (window.location.hash === "#admin") {
    document.getElementById("startScreen").classList.add("hidden");
    document.getElementById("adminScreen").classList.remove("hidden");
  }
});

document.getElementById("loginBtn").addEventListener("click", () => {
  const pass = document.getElementById("adminPass").value;
  const msg = document.getElementById("loginMsg");

  if (pass === currentAdminPass) {
    msg.style.color = "green";
    msg.textContent = "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ âœ…";
    document.getElementById("adminLogin").classList.add("hidden");
    document.getElementById("adminPanel").classList.remove("hidden");
  } else {
    msg.style.color = "red";
    msg.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ";
  }
});

document.getElementById("updatePass").addEventListener("click", () => {
  const newPass = document.getElementById("newPass").value.trim();
  const msg = document.getElementById("updateMsg");
  if (!newPass) {
    msg.textContent = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©.";
    msg.style.color = "red";
    return;
  }
  currentAdminPass = newPass;
  localStorage.setItem("adminPass", newPass);
  msg.style.color = "green";
  msg.textContent = "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±!";
  document.getElementById("newPass").value = "";
});

document.getElementById("saveAdminData").addEventListener("click", () => {
  if (!codesData.length || !questions.length) {
    alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙˆØ§Ù„Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹!");
    return;
  }
  alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ù‚ØªÙ‹Ø§.");
});

/* ========== 6. ØªÙˆÙ„ÙŠØ¯ Ù‚ÙˆØ§Ù„Ø¨ Excel ========== */
function generateCodeTemplate() {
  const ws_data = [["Ø§Ù„ÙƒÙˆØ¯","ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙØ¹ÙŠÙ„","Ø§Ù„Ù…Ø¹Ø±Ù"],["ABC123","",""],["XYZ789","",""]];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Codes");
  XLSX.writeFile(wb, "Ù‚Ø§Ù„Ø¨_Ø§Ù„Ø£ÙƒÙˆØ§Ø¯.xlsx");
}
function generateQuestionTemplate() {
  const ws_data = [["Ø§Ù„Ø³Ø¤Ø§Ù„ (ØµÙˆØ±Ø©)","Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª (Ø£ØŒØ¨ØŒØ¬ØŒØ¯)","Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©","Ø´Ø±Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (ØµÙˆØ±Ø©)","","Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…"],
  ["images/q1.jpg","Ø£:Ù†Ø¹Ù…ØŒØ¨:Ù„Ø§ØŒØ¬:Ø±Ø¨Ù…Ø§ØŒØ¯:ØºÙŠØ± Ù…ØªØ£ÙƒØ¯","Ø¨","images/explain1.jpg","","Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙˆÙ„"]];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb, ws, "Questions");
  XLSX.writeFile(wb, "Ù‚Ø§Ù„Ø¨_Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.xlsx");
}
window.addEventListener("load",()=>{
  const panel=document.getElementById("adminPanel");
  if(panel){
    const btn1=document.createElement("button");
    btn1.textContent="ğŸ“˜ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯";
    btn1.onclick=generateCodeTemplate;
    const btn2=document.createElement("button");
    btn2.textContent="ğŸ“— ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©";
    btn2.onclick=generateQuestionTemplate;
    panel.appendChild(document.createElement("hr"));
    panel.appendChild(btn1);
    panel.appendChild(btn2);
  }
});
</script>
</body>
</html>